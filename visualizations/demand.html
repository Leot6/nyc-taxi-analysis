<!DOCTYPE html>
<html>
    <head>
        <title>Interactive Taxi Demand</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100%;
            }
        </style>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js" 
            integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="
            crossorigin="anonymous">
    </script>
    <script src="jquery.csv.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <script>
            var map;
            var probs;
            var psts;
            var dsts;
            var heatmap;
            var marker;

            var rad = function(x) {
                return x * Math.PI / 180;
            };

            var getDistance = function(p1, p2) {
                var R = 6378137; // Earthâ€™s mean radius in meter
                var dLat = rad(p2.lat() - p1.lat);
                var dLong = rad(p2.lng() - p1.lng);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(rad(p1.lat)) * Math.cos(rad(p2.lat())) *
                    Math.sin(dLong / 2) * Math.sin(dLong / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                return d; // returns the distance in meter
            };

            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 40.77638, lng: -73.96957},
                    zoom: 12,
                    disableDoubleClickZoom: true,
                    draggable: true
                });

                var marker = new google.maps.Marker({
                    title: 'Pickup Station',
                    map: map
                });


                heatmap = new google.maps.visualization.HeatmapLayer();

                d3.csv("probs.csv", function(d) {
                        obj = {};
                        for (var i = 0; i < 200; i++) {
                            obj[i] = +d[i];
                        }
                        return obj;
                    }, function(data) {
                        probs = data;
                });

                d3.csv("pickup_stations.csv", function (d) {
                        return {lat: +d.lat, lng: +d.lng};
                    }, function(data) {
                        psts = data;
                });

                d3.csv("dropoff_stations.csv", function (d) {
                        return {lat: +d.lat, lng: +d.lng};
                    }, function(data) {
                        dsts = data;
                });

                google.maps.event.addListener(map, 'click', function (ev) {
                        var pt = ev.latLng;
                        console.log(pt.lat());
                        console.log(pt.lng());
                        var near_ind = 0;
                        var near_dist = null;

                        for (var i = 0; i < 200; i++) {
                            dist = getDistance(psts[i], pt);
                            if (near_dist == null || dist < near_dist) {
                                near_dist = dist;
                                near_ind = i;
                            }
                        }

                        var markerPos = new google.maps.LatLng(
                            psts[near_ind].lat, psts[near_ind].lng);

                        marker.setPosition(markerPos);

                        console.log(markerPos.lat);
                        console.log(markerPos.lng);
                        console.log(near_ind);

                        var hmData = new Array();
                        for (var i = 0; i < 200; i++) {
                            var loc = new google.maps.LatLng(
                                    dsts[i].lat, dsts[i].lng);
                            hmData.push({location: loc,
                                    weight: 100000 * probs[near_ind][i]});
                        }
                        heatmap.setMap(null);
                        heatmap = new google.maps.visualization.HeatmapLayer({
                            data: hmData,
                            radius: 25
                        });
                        heatmap.setMap(map);
                });

            }

        </script>
        <script src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=visualization"
                async defer>
        </script>
    </body>
</html>
